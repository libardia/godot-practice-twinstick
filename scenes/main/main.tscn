[gd_scene format=3 uid="uid://d3kqivgtew5f1"]

[ext_resource type="Script" uid="uid://6q2pvfruvvdc" path="res://scenes/main/adaptive_cursor.gd" id="1_th5th"]
[ext_resource type="Texture2D" uid="uid://bla1rtpf2tsdl" path="res://assets/img/ui/crosshair_b.png" id="2_7smn1"]
[ext_resource type="PackedScene" uid="uid://c7mxj5wcu4oi7" path="res://obj/player/player.tscn" id="3_raeie"]
[ext_resource type="Script" uid="uid://8r4jy1jnjlt" path="res://scenes/main/random_asteroids.gd" id="4_hxu8e"]
[ext_resource type="Texture2D" uid="uid://dgkv6vvwmaglv" path="res://assets/img/stars/star1.png" id="5_nvumn"]
[ext_resource type="Texture2D" uid="uid://c6drk2bvyg6co" path="res://assets/img/stars/star2.png" id="6_ou6is"]
[ext_resource type="Texture2D" uid="uid://cme4x0a1qpqps" path="res://assets/img/stars/star3.png" id="7_necax"]
[ext_resource type="Texture2D" uid="uid://de1r3syi3aj0p" path="res://assets/img/ship/playerShip3_green.png" id="8_r4lks"]
[ext_resource type="Texture2D" uid="uid://hc2kd68wtigv" path="res://assets/img/ship/playerShip1_green.png" id="9_pg34l"]
[ext_resource type="Texture2D" uid="uid://djx884mryyacp" path="res://assets/img/ship/playerShip2_blue.png" id="10_m4h2d"]
[ext_resource type="Texture2D" uid="uid://b1gl4llpc7rg6" path="res://assets/img/ship/playerShip2_orange.png" id="11_p8abn"]
[ext_resource type="Texture2D" uid="uid://ceqhc62lkpwn3" path="res://assets/img/ship/playerShip3_red.png" id="12_s17dp"]
[ext_resource type="Texture2D" uid="uid://cwjrbk81e6en3" path="res://assets/img/ship/playerShip3_orange.png" id="13_37hlw"]

[sub_resource type="GDScript" id="GDScript_sxbnv"]
script/source = "## Generates a random background of stars
class_name Stars
extends Node2D


@export_group(\"Stars\", \"stars_\")
@export var stars_textures: Array[Texture2D] = []
@export var stars_modulate: Color = Color.WHITE
@export_custom(PROPERTY_HINT_NONE, \"suffix:%\") var stars_min_scale := 0.25
@export_custom(PROPERTY_HINT_NONE, \"suffix:%\") var stars_max_scale := 0.75
@export_group(\"Generation\")
@export_custom(PROPERTY_HINT_ARRAY_TYPE, \"suffix:px\") var chunk_size := 1024.0
@export_custom(PROPERTY_HINT_ARRAY_TYPE, \"suffix:chunks\") var deload_distance := 10.0
@export var star_density := 40
@export var debug := false

var seen_rect: Rect2
var chunks: Dictionary[Vector2i, StarChunk] = {}
var rng := RandomNumberGenerator.new()


func _process(_delta: float) -> void:
    seen_rect = get_viewport_rect()
    var half_size = seen_rect.size / 2.0

    if get_parent() is Parallax2D:
        # Special handling for parallax
        seen_rect.position = get_parent().screen_offset - get_parent().position
    else:
        var cam = get_viewport().get_camera_2d()
        if cam != null:
            seen_rect.position = cam.global_position - half_size

    var seen_chunks = Rect2i(
        floor(seen_rect.position / chunk_size),
        ceil(seen_rect.size / chunk_size) + Vector2.ONE
    )
    var seen_center = seen_rect.get_center() / chunk_size

    # abort if the whole seen area is bigger than deload distance
    if max(seen_chunks.size.x, seen_chunks.size.y) > deload_distance:
        return

    # make chunks if necessary
    for cx in range(seen_chunks.position.x, seen_chunks.end.x):
        for cy in range(seen_chunks.position.y, seen_chunks.end.y):
            var chunk_coord = Vector2i(cx, cy)
            if not chunks.has(chunk_coord):
                if debug:
                    print(\"Stars: make chunk at \", chunk_coord)
                var chunk = StarChunk.new()
                chunk.setup(self, chunk_coord)
                add_child(chunk)
                chunks[chunk_coord] = chunk

    # delete chunks too far away
    for chunk_coord: Vector2i in chunks.keys():
        if seen_center.distance_squared_to(chunk_coord) > deload_distance ** 2:
            if debug:
                print(\"Stars: destroy chunk at \", chunk_coord)
            var chunk = chunks[chunk_coord]
            chunks.erase(chunk_coord)
            chunk.queue_free()
"

[node name="Main" type="Node2D" unique_id=1026637475]

[node name="AdaptiveCursor" type="Node" parent="." unique_id=375166096]
script = ExtResource("1_th5th")
cursor = ExtResource("2_7smn1")
hotspot = Vector2(14, 14)
controller_cursor_mode = 1

[node name="Player" parent="." unique_id=1861245870 instance=ExtResource("3_raeie")]
z_index = 1
rotation = -1.5707964

[node name="Asteroids" type="Node2D" parent="." unique_id=41389052]
script = ExtResource("4_hxu8e")

[node name="Parallax2D" type="Parallax2D" parent="." unique_id=1747640961]
z_index = -10
scroll_scale = Vector2(0.2, 0.2)

[node name="Stars" type="Node2D" parent="Parallax2D" unique_id=1312143591]
script = SubResource("GDScript_sxbnv")
stars_textures = Array[Texture2D]([ExtResource("5_nvumn"), ExtResource("6_ou6is"), ExtResource("7_necax")])
stars_modulate = Color(0.39607844, 0.39607844, 0.39607844, 0.84705883)
metadata/_custom_type_script = "uid://davqcsxn32c3l"

[node name="PlayerShip3Green" type="Sprite2D" parent="." unique_id=218668830]
position = Vector2(-287, 60)
texture = ExtResource("8_r4lks")

[node name="PlayerShip1Green" type="Sprite2D" parent="." unique_id=788140789]
position = Vector2(336, 23)
texture = ExtResource("9_pg34l")

[node name="PlayerShip2Blue" type="Sprite2D" parent="." unique_id=644809038]
position = Vector2(295, -165)
texture = ExtResource("10_m4h2d")

[node name="PlayerShip2Orange" type="Sprite2D" parent="." unique_id=1564196216]
position = Vector2(-168, 105)
texture = ExtResource("11_p8abn")

[node name="PlayerShip3Red" type="Sprite2D" parent="." unique_id=182987722]
position = Vector2(-203, -75)
texture = ExtResource("12_s17dp")

[node name="PlayerShip3Orange" type="Sprite2D" parent="." unique_id=1279975929]
position = Vector2(61, 147)
texture = ExtResource("13_37hlw")

[node name="PlayerShip3Green2" type="Sprite2D" parent="." unique_id=1851546525]
position = Vector2(431, -208)
texture = ExtResource("8_r4lks")

[node name="PlayerShip3Red2" type="Sprite2D" parent="." unique_id=1543910054]
position = Vector2(-379, -180)
texture = ExtResource("12_s17dp")
